<!DOCTYPE html>
<html>
  <head>
 Â  Â <title>Empaquetar - Com empaquetar i distribuÃ¯r els nostres paquets de Python</title>
    <meta charset="utf-8">
    <style>
      @import url(https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
      @import url(https://fonts.googleapis.com/css?family=Roboto);
      @import url(https://fonts.googleapis.com/css?family=Roboto+Mono);

      body { font-family: 'Roboto'; }
      h1, h2, h3 {
        font-family: 'Yanone Kaffeesatz';
        font-weight: normal;
      }
      .remark-code, .remark-inline-code { font-family: 'Roboto Mono'; font-size: 0.6em }
      .small {
        font-size: 0.8em;
      }
      a:link, a:visited {
        color: #E40066;
        text-decoration: underline;
      }
    </style>
  </head>
  <body>
    <textarea id="source">
class: center, middle
count: false
# Com empaquetar
## Empaquetar i distribuÃ¯r els nostres paquets de Python

![PyGRN](https://avatars1.githubusercontent.com/u/28831124?v=4&s=200)

[Eduard Carreras i Nadal](mailto:ecarreras@gmail.com)

31/03/2022 - PyGRN #22

[![](https://i.creativecommons.org/l/by-sa/4.0/88x31.png)](http://creativecommons.org/licenses/by-sa/4.0/)

---

# Qui sÃ³c jo?

- SÃ³c un infiltrat en el mÃ³n del software (sÃ³c teleco)
- Apassionat del software i del proÄ‡es **art**esanal.
- Co-Fundador de [GISCE-TI, S.L](http://gisce.net)
- Desenvolupant en Python des del 2007 (Python â¤ï¸)
- Amant del programari lliure
- [LinkedIn](https://www.linkedin.com/in/ecarreras/), [Twitter](https://twitter.com/ecarreras)
  i [GitHub](https://github.com/ecarreras)

---
# Agenda

  1. QuÃ¨ Ã©s un paquet de Python
  2. Estructura d'un paquet
  3. Integrar amb scripts (CLI)
  4. Integrar amb tests
  5. QuÃ¨ sÃ³n els `entry_points`?
  6. Alternatives a setuptools
  7. ReferÃ¨ncies

---
# QuÃ¨ Ã©s un paquet de Python

- Una colÂ·lecciÃ³ de mÃ²duls agrupats per un objectiu/funcionalitat (llibreria).
  - Ex. [Requests](https://docs.python-requests.org/en/latest/): comunicaciÃ³ HTTP
  - Ex. [SQLAlchemy](https://www.sqlalchemy.org/): ORM per diferents bases de dades
- La manera mÃ©s comuna d'instalÂ·lar un paquet Ã©s a travÃ©s de `pip` i el repositori [Pypi](https://pypi.org/)
  - Ex. `python3 -m pip install requests`

## PerÃ² avui no apendrem a instalÂ·lar i gestionar entorns!

- AixÃ² ho deixem per alguna altre sessiÃ³ ðŸ˜‰

## Avui farem i publicarem els nostres paquets! ðŸ”


???

- https://stackoverflow.com/questions/62983756/what-is-pyproject-toml-file-for


---
# Estructura d'un paquet

### Tenim el segÃ¼ent projecte

```
sampleproject/
â””â”€â”€ src/
    â””â”€â”€ sample/
        â”œâ”€â”€ __init__.py
        â””â”€â”€ simple.py
```
- On el contingut de `simple.py` Ã©s:

```python
def add_one(number):
    return number + 1
```

---
# Estructura d'un paquet

```
sampleproject/
â”œâ”€â”€ LICENSE
â”œâ”€â”€ pyproject.toml(*)
â”œâ”€â”€ README.md
â”œâ”€â”€ setup.py â¬…ï¸
â”œâ”€â”€ MANIFEST.in
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ src/
â”‚   â””â”€â”€ sample/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â””â”€â”€ simple.py
â””â”€â”€ tests/
```

- Hi ha el fitxer `setup.py` que s'utilitza per definir el paquet
- Es pot fer servir `setup.cfg` que Ã©s el mateix, perÃ² no Ã©s dinÃ mic.
  - ðŸ’¡ El `.py` s'executa en el moment d'instalÂ·laciÃ³.
  - âš ï¸ Si hi ha algun error en el `setup.py` no instalÂ·larÃ .

---

# Fitxer setup.py

```python
import setuptools

with open("README.md", "r", encoding="utf-8") as fh:
    long_description = fh.read()

with open("requirements.txt") as r:
    install_requires = [x.strip() for x in r.readlines()]

setuptools.setup(
    name="sample-ecarreras",
    version="0.0.1",
    author="Example Author",
    author_email="author@example.com",
    description="A small example package",
    long_description=long_description,
    long_description_content_type="text/markdown",
    url="https://github.com/pypa/sampleproject",
    project_urls={
        "Bug Tracker": "https://github.com/pypa/sampleproject/issues",
    },
    classifiers=[
        "Programming Language :: Python :: 3",
        "License :: OSI Approved :: MIT License",
        "Operating System :: OS Independent",
    ],
    package_dir={"": "src"},
    install_requires=install_requires,
    packages=setuptools.find_packages(where="src"),
    python_requires=">=3.6",
)
```
---
# Pujar el nostre paquet

- Farem servir una utilitat que es diu [twine](https://twine.readthedocs.io/en/stable/)
- Necessitem un [compte a Pypi](https://pypi.org/account/register/)

```
python3 -m pip install twine
python3 setup.py sdist  # Creem el paquet a la carpeta /dist
twine upload dist/sample-ecarreras-0.0.1.tar.gz
```

- Ara ja el podem instalÂ·lar! ðŸ‘

```
python3 -m pip install sample-ecarreras
```

- Podem automatitzar-ho amb [Github Actions](https://github.com/pypa/sampleproject/blob/main/.github/workflows/release.yml), de forma
que quan fem un tag al repositori ens pugi el paquet

---
# Integrar amb scripts (CLI)

- Moltes vegades volem crear utilitzats a travÃ©s de comandes
- Farem servir [Click](https://click.palletsprojects.com/) perÃ² podem fer servir nomÃ©s stdlib

```
â”œâ”€â”€ src/
â”‚   â””â”€â”€ sample/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â””â”€â”€ simple.py
â”‚       â””â”€â”€ cli.py
``` 

 ```python
import click
from sample.simple import add_one

@click.command()
@click.argument('number', nargs=1, type=click.INT)
def main(number):
    print(add_one(number))

if __name__ == '__main__':
    main()
```

- AixÃ² ja es pot executar amb l'intÃ¨rpret de python, perÃ² volem que ens creÃ¯ un executable
del tipus:

```
$ add_one 6
7
```
---
# Integrar amb scripts (CLI)

- Utilitzarem un parÃ metre anomenat [`console_scripts`](https://setuptools.pypa.io/en/latest/userguide/entry_point.html) del `setup.py`

```python
setup(
    entry_points={
      'console_scripts': [
          'add_one = sample.cli:main'
      ]
    }
)
```

- Es pot indicar quin nom tindrÃ  l'script (add_one en aquest cas)
- On es troba la funciÃ³ que ha d'executar (la funciÃ³ `main` que es troba a `sample.cli` )


---
# QuÃ¨ sÃ³n els `entry_points`?

- Ho hem fet servir abans per crear scripts executables, perÃ² serveix per molt mÃ©s
- Ã‰s una forma que ens permet que altres paquets interaccionin amb el nostre, com
un sistema de *plug-ins*.
- Funciona amb una clau que tÃ© diferents valors

## Com els podem descobrir?

```python
from importlib import metadata
eps = metadata.entry_points()['my_entry_point_name']
for ep in eps:
    plugin = ep.load()
    plugin()
```

- Exemple de [plugins amb PyTest](https://docs.pytest.org/en/latest/how-to/writing_plugins.html#setuptools-entry-points)

---
# Alternatives a setuptools

- Fins fa un temps l'Ãºnica manera de crear i distribuir paquets era amb `setuptools`
  - `setuptools` no forma part de l'stdlib, quÃ¨ passa si no el tenim?

## pyproject.toml

- Entra en joc el `pyproject.toml`, aquest fitxer ens defineix com construir el paquet

```toml
[build-system]
requires = ["setuptools>=42"]
build-backend = "setuptools.build_meta"
```

- Aquest moviment, ha obert la manera de gestionar paquets i ens permet fer servir altres eines
com [Poetry](https://python-poetry.org/), [Flit](https://flit.pypa.io/en/latest/) o [PDM](https://pdm.fming.dev/)

### PEPs
- [PEP-518](https://peps.python.org/pep-0518/), [PEP-517](https://peps.python.org/pep-0517/), [PEP-621](https://peps.python.org/pep-0621/),
[PEP-660](https://peps.python.org/pep-0660/)


---
# ReferÃ¨ncies

- [Python Packaging User Guide](https://packaging.python.org/en/latest/)
- [Python Packaging Authority](https://www.pypa.io/en/latest/)
- [Llista de classifacts pels paquests](https://pypi.org/classifiers/)
- [GitHub PyPA](https://github.com/pypa)

---

class: center, middle

# Preguntes?
# ðŸ™ˆ ðŸ™‰ ðŸ™Š

---
class: center, middle

# Moltes grÃ cies!

    </textarea>
    <script src="https://remarkjs.com/downloads/remark-latest.min.js">
    </script>
    <script>
      var slideshow = remark.create({
        highlightStyle: 'darcula',
        highlightLanguage: 'remark',
        highlightLines: true,
        slideNumberFormat: '%current%/%total%',
        ratio: '4:3'
      });
    </script>
  </body>
</html>
